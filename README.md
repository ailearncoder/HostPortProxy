# C++ 动态端口反向代理

一个轻量级的C++ HTTP反向代理服务器，它根据传入请求的 `Host` 头动态地将请求转发到本地的不同端口。

## 🚀 项目简介

本项目实现了一个简单的HTTP反向代理服务器，它监听一个固定的端口（默认为 `8080`），并根据客户端请求的 `Host` 头来决定将请求转发到本地（`127.0.0.1`）的哪个端口。

例如，如果客户端请求 `http://12345.axyz.cc:8080/path`，代理服务器会解析 `Host` 头中的 `12345`，并将该请求转发到 `http://127.0.0.1:12345/path`。这种设计使得你可以通过一个统一的入口端口，灵活地代理到本地运行的多个服务。

## ✨ 特性

*   **动态端口转发**: 根据 `Host` 头的前缀（例如 `12345.example.com` 中的 `12345`）动态确定目标端口。
*   **高性能**: 使用 `epoll` 进行高效的I/O多路复用，支持大量并发连接。
*   **非阻塞I/O**: 所有网络操作均采用非阻塞模式，避免线程阻塞。
*   **轻量级**: 纯C++实现，无外部依赖，编译后体积小，资源占用低。
*   **错误处理**: 包含基本的HTTP错误响应（如 400 Bad Request, 413 Request Entity Too Large, 502 Bad Gateway）。
*   **日志记录**: 详细的调试和信息日志输出，方便问题排查。

## 🛠️ 如何工作

1.  **监听**: 服务器在 `LISTEN_PORT` (默认为 `8080`) 监听传入的HTTP连接。
2.  **读取请求头**: 接收到客户端连接后，服务器会读取完整的HTTP请求头。
3.  **解析 `Host` 头**: 从请求头中提取 `Host` 字段。例如，如果 `Host` 是 `12345.yourdomain.com`，它会解析出 `12345` 作为目标端口。
4.  **建立目标连接**: 服务器尝试连接到 `127.0.0.1` 上解析出的目标端口。
5.  **数据转发**: 一旦与目标服务器建立连接，代理服务器将客户端和目标服务器之间的数据进行双向转发。
6.  **连接管理**: 使用 `epoll` 监控所有套接字的读写事件，并在连接关闭或发生错误时进行清理。

## 🚀 快速开始

### 前提条件

*   C++ 编译器 (推荐 `g++`)
*   Linux 环境 (本项目使用了 `epoll`，是Linux特有的系统调用)

### 构建

在项目根目录下执行以下命令进行编译：

```bash
g++ -g http_reverse_proxy.cpp -o main
```

### 运行

编译成功后，直接运行可执行文件：

```bash
./main
```

服务器将开始监听 `8080` 端口。

### 使用示例

假设你本地有一个服务运行在 `127.0.0.1:9000`，另一个服务运行在 `127.0.0.1:9001`。

1.  **启动你的本地服务**:
    ```bash
    # 示例：启动一个简单的Python HTTP服务器在9000端口
    python3 -m http.server 9000
    # 示例：启动另一个简单的Python HTTP服务器在9001端口
    python3 -m http.server 9001
    ```

2.  **通过代理访问**:
    *   要访问 `127.0.0.1:9000` 上的服务，你可以使用 `curl` 或浏览器访问 `http://9000.anydomain.com:8080` (这里的 `anydomain.com` 可以是任意域名，只要确保 `Host` 头的前缀是 `9000` 即可)。
        ```bash
        curl -H "Host: 9000.example.com" http://127.0.0.1:8080/
        ```
    *   要访问 `127.0.0.1:9001` 上的服务：
        ```bash
        curl -H "Host: 9001.test.org" http://127.0.0.1:8080/
        ```

    **注意**: 实际使用时，你可能需要配置DNS解析或修改 `/etc/hosts` 文件，将 `9000.example.com` 或 `9001.test.org` 指向运行代理服务器的IP地址。如果代理服务器和客户端在同一台机器上，直接使用 `127.0.0.1` 即可。

## 💡 用途与优势

*   **本地开发环境**: 当你在本地开发多个微服务，它们监听不同的端口时，可以使用此代理将它们统一暴露在一个端口下，方便调试和访问。
*   **端口映射**: 解决端口冲突或简化访问路径的问题。
*   **测试**: 在测试环境中，可以模拟不同的 `Host` 头来验证后端服务的行为。
*   **简单易用**: 对于特定的动态端口转发需求，它比配置复杂的Nginx或HAProxy更为轻量和直接。

## ⚠️ 限制与已知问题

*   **仅支持HTTP**: 本代理不支持HTTPS流量的直接转发。如果需要HTTPS，你需要在代理前端配置SSL卸载。
*   **目标地址固定**: 目前目标服务器地址硬编码为 `127.0.0.1`。如果需要转发到其他IP地址，需要修改代码。
*   **简单的 `Host` 头解析**: 仅解析 `Host` 头中第一个 `.` 之前的部分作为端口号。不处理复杂的域名解析或多级子域名。
*   **无高级代理功能**: 不支持缓存、负载均衡、URL重写等高级代理功能。
*   **错误处理待完善**: 某些边缘情况下的错误处理可能不够健壮。

## 🤝 贡献

欢迎任何形式的贡献！如果你有改进建议、Bug报告或新功能需求，请随时提交Issue或Pull Request。

## 📄 许可证

本项目采用 MIT 许可证。详情请参阅 [LICENSE](LICENSE) 文件。
